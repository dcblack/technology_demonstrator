#!/bin/bash

function Display_Syntax() {
  ERRORS=0
  if [[ $# != 0 ]]; then
    ERRORS=1
    echo "ERROR: $*"
  fi
  cat <<EOF
SYNTAX: mktar [-n] ( all | hls | src | sc | zed )
EOF
  exit $ERRORS
}

L=0
N=0
Q=0
CMD=""
while [[ $# != 0 ]]; do
  if [[ "$1" == "-l" ]]; then
    L=1; N=1;
  elif [[ "$1" == "-n" ]]; then
    N=1;
  elif [[ "$1" == "-q" ]]; then
    Q=1;
  elif [[ "$1" =~ -.* ]]; then
    Display_Syntax "Unexpected option '$1'!"
  elif [[ $CMD == "" ]]; then
    CMD="$1"
  else
    Display_Syntax "Unexpected argument '$1'!"
  fi
  shift
done
if [[ $CMD == "" ]]; then
  Display_Syntax
fi

D=$(realpath $(dirname $(find ../.. -path '*Example/setup.profile')))
B=$(basename $D)
LOGFILE="$D/$CMD-MANIFEST.log"
TARBALL="$D/$CMD.tgz"
TAROPTS="chvzf"
STD="$B/README.txt $B/ABOUT.txt $B/LICENSE.txt $B/NOTES.txt $B/bin $B/lib $B/etc $B/setup.profile"
LIST=""
hls_LIST=$(echo $B/hls/*.tcl $B/src/*.{h,cpp} $B/src/Makefile $B/hls/example_run.log)
src_LIST=$(echo $B/src/*.{h,cpp} $B/src/Makefile $B/src/make-golden.log)
sysc_LIST=$(echo $B/sysc/*.{h,cpp,c} $B/sysc/Makefile $B/sysc/*.log)
zed_LIST=$(echo $B/zedb*/*.{h,c} $B/zedb*/Makefile $B/zedb*/*.log)
all_LIST=$(echo $hls_list $src_list $sysc_LIST $zed_LIST)
cd $(dirname $D)
case $CMD in
  all) LIST=$all_LIST
       ;;
  hls) LIST=$hls_LIST
       ;;
  src) LIST=$src_LIST
       ;;
  sc ) LIST=$sysc_LIST
       ;;
  zed) LIST=$zed_LIST
       ;;
  *  ) Display_Syntax "Unknown directive '$CMD'"
       ;;
esac
if [[ "$LIST" != "" ]]; then
  if [[ $L == 1 ]]; then
    for e in $LIST; do
      file $e
      test -r "$e" || echo "Missing $e"
    done
  fi
  if [[ $Q == 0 ]]; then
    echo "tar $TAROPTS '$TARBALL' $STD '$LIST' > $LOGFILE" ;
  fi
  if [[ $N == 0 ]]; then
    tar $TAROPTS $TARBALL $STD $LIST > $LOGFILE 2>&1;
    printf "Created %s & %s\n" "$B/$(basename $TARBALL)" "$B/$(basename $LOGFILE)"
  fi
  exit 0;
else
  printf "ERROR: Please select a valid option\n"
  exit 1;
fi

# Author: David C Black
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
